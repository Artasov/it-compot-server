# Используйте официальный образ Python как базовый
FROM python:3.11-alpine

# Установите рабочую директорию в контейнере
WORKDIR /srv

# Установите зависимости
# Скопируйте только файлы зависимостей в контейнер и установите их
# Это улучшает кэширование слоев Docker
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Установка Chrony для синхронизации времени
RUN apk add --no-cache chrony
# Запуск Chrony и настройка времени при старте контейнера
RUN echo "server pool.ntp.org iburst" >> /etc/chrony/chrony.conf
RUN adduser -D celeryuser
USER celeryuser
# Скопируйте остальную часть вашего кода Django в контейнер
COPY . .
# Установите переменные окружения для Celery
# Сделаем это в docker-compose
#ENV CELERY_BROKER_URL redis://redis:6379/0
#ENV CELERY_RESULT_BACKEND redis://redis:6379/0
#ENV CELERY_ACCEPT_CONTENT application/json
#ENV CELERY_TASK_SERIALIZER json
#ENV CELERY_RESULT_SERIALIZER json
ENTRYPOINT ["sh", "/srv/entrypoint_celerybeat.sh"]